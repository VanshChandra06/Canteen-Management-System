<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Sea Canteen — Admin / User</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        --sea-1: #0f766e;
        --sea-2: #2dd4bf;
        --sea-3: #9be7d1;
        --muted: #f6fffb;
        --accent: #064e4a;
        --text: #012a2a;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #ecfffb, #f8fffd);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header {
        background: var(--sea-3);
        padding: 12px 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      header h1 {
        margin: 0;
        font-size: 18px;
        color: var(--accent);
      }
      main {
        display: flex;
        flex: 1;
        gap: 20px;
        padding: 20px;
      }
      .landing {
        margin: auto;
        text-align: center;
        max-width: 800px;
      }
      .btn {
        display: inline-block;
        padding: 10px 14px;
        border-radius: 8px;
        background: var(--sea-1);
        color: white;
        border: none;
        cursor: pointer;
        margin: 6px;
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid rgba(0, 0, 0, 0.06);
        color: var(--accent);
      }
      .card {
        background: white;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 6px 18px rgba(3, 22, 18, 0.03);
        margin-bottom: 16px;
      }
      .sidebar {
        width: 240px;
        padding: 16px;
        border-right: 1px solid rgba(0, 0, 0, 0.03);
      }
      .content {
        flex: 1;
        padding: 8px;
      }
      .hidden {
        display: none;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 8px;
        border-bottom: 1px solid #f1f6f5;
        text-align: left;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      form input,
      form select {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #dfeeea;
        width: 100%;
      }
      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
      .muted {
        color: #476a66;
        font-size: 13px;
      }
      .small {
        font-size: 13px;
      }
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }
      .product-card {
        border-radius: 10px;
        padding: 12px;
        background: linear-gradient(180deg, #fff, #f7fffb);
        box-shadow: 0 4px 12px rgba(2, 20, 18, 0.03);
      }
      .price {
        font-weight: 700;
        color: var(--sea-1);
      }
      footer {
        padding: 12px;
        text-align: center;
        color: #064e4a;
        font-size: 13px;
      }
      .error {
        color: #b00020;
      }
      @media (max-width: 900px) {
        main {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
        }
        .grid-3 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Sea Canteen</h1>
      <div class="muted">Single origin app — Admin & Store</div>
    </header>

    <main>
      <!-- Landing -->
      <section id="landing" class="card landing">
        <h2>Welcome to Sea Canteen</h2>
        <p class="muted">Choose a role to continue</p>
        <div style="margin-top: 16px">
          <button class="btn" onclick="enterRole('admin')">Admin</button>
          <button class="btn btn-ghost" onclick="enterRole('user')">
            User / Store
          </button>
        </div>
        <hr />
        <p class="small muted">
          Some output may take upto 10 seconds to show when updated.
        </p>
      </section>

      <!-- Admin UI -->
      <aside id="admin-ui" class="sidebar hidden card">
        <div class="muted">Admin menu</div>
        <div style="margin-top: 8px" class="row">
          <button class="btn-ghost" onclick="showAdminSection('products')">
            Products
          </button>
          <button class="btn-ghost" onclick="showAdminSection('categories')">
            Categories
          </button>
        </div>
        <div style="margin-top: 8px" class="row">
          <button class="btn-ghost" onclick="showAdminSection('customers')">
            Customers
          </button>
          <button class="btn-ghost" onclick="showAdminSection('orders')">
            Orders
          </button>
        </div>
        <div style="margin-top: 8px">
          <button class="btn-ghost" onclick="showAdminSection('payments')">
            Payments
          </button>
        </div>

        <hr />
        <div style="margin-top: 8px">
          <button class="btn" onclick="enterRole('landing')">Back</button>
        </div>
      </aside>

      <section id="admin-content" class="content hidden">
        <!-- Products admin -->
        <div id="admin-products" class="card hidden">
          <div
            class="row"
            style="justify-content: space-between; align-items: center"
          >
            <h3>Products</h3>
            <div>
              <button class="btn" onclick="openProductForm()">
                + New Product
              </button>
            </div>
          </div>
          <div id="products-list"></div>

          <div id="product-form" class="card hidden" style="margin-top: 12px">
            <h4 id="product-form-title">Add product</h4>
            <form id="pf">
              <div class="grid-3">
                <div>
                  <label>Name</label><input name="product_name" required />
                </div>
                <div>
                  <label>Category</label
                  ><select name="category_id" id="product-category"></select>
                </div>
                <div>
                  <label>Price</label
                  ><input name="price" type="number" step="0.01" />
                </div>
                <div>
                  <label>Stock</label><input name="stock" type="number" />
                </div>
                <div>
                  <label>Description</label><input name="description" />
                </div>
              </div>
              <div style="margin-top: 8px" class="row">
                <button class="btn" type="submit">Save</button>
                <button
                  type="button"
                  onclick="closeProductForm()"
                  class="btn-ghost"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Categories admin -->
        <div id="admin-categories" class="card hidden">
          <div
            class="row"
            style="justify-content: space-between; align-items: center"
          >
            <h3>Categories</h3>
            <div>
              <button class="btn" onclick="openCategoryForm()">
                + New Category
              </button>
            </div>
          </div>
          <div id="categories-list" style="margin-top: 12px"></div>

          <div id="category-form" class="card hidden" style="margin-top: 12px">
            <h4>Add category</h4>
            <form id="cf">
              <div class="row">
                <div style="flex: 2">
                  <label>Name</label>
                  <input name="category_name" required />
                </div>
              </div>
              <div style="margin-top: 8px">
                <label>Description</label>
                <input name="description" />
              </div>
              <div style="margin-top: 8px" class="row">
                <button class="btn" type="submit">Save</button>
                <button
                  type="button"
                  onclick="closeCategoryForm()"
                  class="btn-ghost"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Customers admin -->
        <div id="admin-customers" class="card hidden">
          <div
            class="row"
            style="justify-content: space-between; align-items: center"
          >
            <h3>Customers</h3>
            <div>
              <button class="btn" onclick="openCustomerForm()">
                + New Customer
              </button>
            </div>
          </div>
          <div id="customers-list" style="margin-top: 12px"></div>

          <div id="customer-form" class="card hidden" style="margin-top: 12px">
            <h4>Add customer</h4>
            <form id="custf">
              <div class="grid-3">
                <div>
                  <label>First name</label><input name="first_name" required />
                </div>
                <div><label>Last name</label><input name="last_name" /></div>
                <div><label>Email</label><input name="email" /></div>
                <div><label>Phone</label><input name="phone" /></div>
                <div style="grid-column: 1 / -1">
                  <label>Address</label><input name="address" />
                </div>
              </div>
              <div style="margin-top: 8px" class="row">
                <button class="btn" type="submit">Save</button>
                <button
                  type="button"
                  onclick="closeCustomerForm()"
                  class="btn-ghost"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Orders admin -->
        <div id="admin-orders" class="card hidden">
          <div
            class="row"
            style="justify-content: space-between; align-items: center"
          >
            <h3>Orders</h3>
            <div>
              <button class="btn" onclick="openOrderForm()">+ New Order</button>
            </div>
          </div>
          <div id="orders-list" style="margin-top: 12px"></div>

          <div id="order-form" class="card hidden" style="margin-top: 12px">
            <h4>Create order</h4>
            <form id="of">
              <div class="row">
                <div style="flex: 2">
                  <label>Customer (select existing)</label
                  ><select name="customer_id" id="order-customer"></select>
                </div>
                <div style="flex: 1">
                  <label>Status</label
                  ><select name="status">
                    <option>Pending</option>
                    <option>Completed</option>
                  </select>
                </div>
              </div>
              <div style="margin-top: 8px">
                <label>Items (select product then qty)</label>
                <div id="order-items-area"></div>
                <button type="button" class="btn" onclick="addOrderItemRow()">
                  Add item
                </button>
              </div>

              <div style="margin-top: 8px" class="row">
                <button class="btn" type="submit">Create</button>
                <button
                  type="button"
                  onclick="closeOrderForm()"
                  class="btn-ghost"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Payments admin -->
        <div id="admin-payments" class="card hidden">
          <div
            class="row"
            style="justify-content: space-between; align-items: center"
          >
            <h3>Payments</h3>
            <div>
              <button class="btn" onclick="openPaymentForm()">
                + New Payment
              </button>
            </div>
          </div>
          <div id="payments-list" style="margin-top: 12px"></div>

          <div id="payment-form" class="card hidden" style="margin-top: 12px">
            <h4>Add payment</h4>
            <form id="payf">
              <div class="row">
                <div style="flex: 1">
                  <label>Order (select)</label>
                  <select name="order_id" id="payment-order"></select>
                </div>
                <div style="flex: 1">
                  <label>Method</label>
                  <select name="payment_method">
                    <option>Cash</option>
                    <option>Card</option>
                    <option>UPI</option>
                    <option>Cash on Delivery</option>
                  </select>
                </div>
                <div style="flex: 1">
                  <label>Status</label>
                  <select name="status">
                    <option>Success</option>
                    <option>Pending</option>
                    <option>Failed</option>
                  </select>
                </div>
              </div>
              <div style="margin-top: 8px" class="row">
                <button class="btn" type="submit">Save</button>
                <button
                  type="button"
                  onclick="closePaymentForm()"
                  class="btn-ghost"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- User (Store) UI -->
      <section id="user-ui" class="content hidden">
        <div
          class="row"
          style="
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <h3>Store</h3>
          <div>
            <button class="btn-ghost" onclick="enterRole('landing')">
              Back
            </button>
            <button class="btn" onclick="openCart()">
              Cart (<span id="cart-count">0</span>)
            </button>
          </div>
        </div>

        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div><strong>Products</strong></div>
            <div class="muted">Browse and add to cart</div>
          </div>
          <div
            id="product-grid"
            style="margin-top: 12px"
            class="product-grid"
          ></div>
        </div>

        <!-- Cart / Checkout -->
        <div id="cart-modal" class="card hidden" style="margin-top: 12px">
          <h4>Your Cart</h4>
          <div id="cart-items"></div>
          <div style="margin-top: 8px" class="row">
            <div class="muted">Total: ₹ <span id="cart-total">0</span></div>
            <div style="margin-left: auto">
              <button class="btn" onclick="checkout()">Checkout</button>
              <button class="btn-ghost" onclick="closeCart()">Close</button>
            </div>
          </div>
        </div>

        <!-- Simple checkout form -->
        <div id="checkout-form" class="card hidden" style="margin-top: 12px">
          <h4>Checkout</h4>
          <form id="checkoutf">
            <div class="row">
              <div style="flex: 2">
                <label>First name</label><input name="first_name" required />
              </div>
              <div style="flex: 2">
                <label>Last name</label><input name="last_name" />
              </div>
              <div style="flex: 2">
                <label>Email</label><input name="email" />
              </div>
              <div style="flex: 1">
                <label>Phone</label><input name="phone" />
              </div>
            </div>

            <div style="margin-top: 8px" class="row">
              <button class="btn" type="submit">Place Order</button>
              <button
                type="button"
                class="btn-ghost"
                onclick="cancelCheckout()"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>

        <!-- After order: payment -->
        <div id="payment-ui" class="card hidden" style="margin-top: 12px">
          <h4>Make Payment</h4>
          <div class="muted">
            Order ID: <span id="pay-order-id"></span> • Amount: ₹<span
              id="pay-amount"
            ></span>
          </div>
          <form id="payf-user" style="margin-top: 8px">
            <div class="row">
              <div style="flex: 1">
                <label>Method</label>
                <select name="payment_method">
                  <option>Cash</option>
                  <option>Card</option>
                  <option>UPI</option>
                </select>
              </div>
            </div>
            <div style="margin-top: 8px" class="row">
              <button class="btn" type="submit">Pay</button>
              <button type="button" class="btn-ghost" onclick="cancelPayment()">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </section>
    </main>

    <footer>Sea Canteen • Admin & User</footer>

    <script>
      const API = "/api";

      function enterRole(r) {
        document.getElementById("landing").classList.add("hidden");
        document.getElementById("admin-ui").classList.add("hidden");
        document.getElementById("admin-content").classList.add("hidden");
        document.getElementById("user-ui").classList.add("hidden");

        if (r === "admin") {
          document.getElementById("admin-ui").classList.remove("hidden");
          document.getElementById("admin-content").classList.remove("hidden");
          showAdminSection("products");
          fetchProducts();
          fetchCategoriesForSelect();
          fetchCustomers();
        } else if (r === "user") {
          document.getElementById("user-ui").classList.remove("hidden");
          fetchProductsForStore();
        } else {
          document.getElementById("landing").classList.remove("hidden");
        }
      }

      function showAdminSection(s) {
        [
          "admin-products",
          "admin-categories",
          "admin-customers",
          "admin-orders",
          "admin-payments",
        ].forEach((id) => document.getElementById(id).classList.add("hidden"));
        if (s === "products")
          document.getElementById("admin-products").classList.remove("hidden");
        if (s === "categories")
          document
            .getElementById("admin-categories")
            .classList.remove("hidden");
        if (s === "customers")
          document.getElementById("admin-customers").classList.remove("hidden");
        if (s === "orders")
          document.getElementById("admin-orders").classList.remove("hidden");
        if (s === "payments")
          document.getElementById("admin-payments").classList.remove("hidden");
      }

      function el(tag, attrs = {}, ...children) {
        const e = document.createElement(tag);
        for (const k in attrs) {
          if (k === "class") e.className = attrs[k];
          else if (k.startsWith("on")) e.addEventListener(k.slice(2), attrs[k]);
          else e.setAttribute(k, attrs[k]);
        }
        for (const c of children) {
          if (typeof c === "string") e.appendChild(document.createTextNode(c));
          else if (c) e.appendChild(c);
        }
        return e;
      }

      /* ----------------- ADMIN: PRODUCTS ----------------- */
      async function fetchProducts() {
        const res = await fetch(API + "/products");
        const data = await res.json();
        const container = document.getElementById("products-list");
        container.innerHTML = "";
        if (data.length === 0) {
          container.innerHTML = '<div class="muted">No products</div>';
          return;
        }
        const table = el("table");
        table.innerHTML =
          "<thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th></th></tr></thead>";
        const tbody = el("tbody");
        data.forEach((p) => {
          const tr = el("tr");
          tr.innerHTML = `<td>${p.product_id || ""}</td><td>${
            p.product_name
          }</td><td>${p.category_name || ""}</td><td>${p.price || ""}</td><td>${
            p.stock || ""
          }</td>`;
          const actions = el("td");
          const edit = el(
            "button",
            { onclick: () => openProductForm(p) },
            "Edit"
          );
          const del = el(
            "button",
            { onclick: () => deleteProduct(p.product_id) },
            "Delete"
          );
          actions.appendChild(edit);
          actions.appendChild(del);
          tr.appendChild(actions);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        container.appendChild(table);
      }

      function openProductForm(p) {
        document.getElementById("product-form").classList.remove("hidden");
        document.getElementById("product-form-title").textContent = p
          ? "Edit product"
          : "Add product";
        const f = document.getElementById("pf");
        f.product_id.value = p ? p.product_id : "";
        f.product_name.value = p ? p.product_name : "";
        f.description.value = p ? p.description : "";
        f.price.value = p ? p.price : "";
        f.stock.value = p ? p.stock : "";
        f.category_id.value = p ? p.category_id : "";
      }
      function closeProductForm() {
        document.getElementById("pf").reset();
        document.getElementById("product-form").classList.add("hidden");
      }

      document.getElementById("pf").addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        data.price = parseFloat(data.price || 0);
        data.stock = parseInt(data.stock || 0);
        if (data.product_id) {
          const id = data.product_id;
          await fetch(API + "/products/" + id, {
            method: "PUT",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(data),
          });
        } else {
          await fetch(API + "/products", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(data),
          });
        }
        closeProductForm();
        fetchProducts();
      });

      async function deleteProduct(id) {
        if (!confirm("Delete product " + id + "?")) return;
        await fetch(API + "/products/" + id, { method: "DELETE" });
        fetchProducts();
      }

      async function fetchCategoriesForSelect() {
        const res = await fetch(API + "/categories");
        const cats = await res.json();
        const sel = document.getElementById("product-category");
        if (!sel) return;
        sel.innerHTML = '<option value="">-- none --</option>';
        cats.forEach((c) => {
          const o = el("option", { value: c.category_id }, c.category_name);
          sel.appendChild(o);
        });
      }

      /* ----------------- ADMIN: CATEGORIES ----------------- */
      function openCategoryForm() {
        document.getElementById("category-form").classList.remove("hidden");
      }
      function closeCategoryForm() {
        document.getElementById("cf").reset();
        document.getElementById("category-form").classList.add("hidden");
      }

      document.getElementById("cf").addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        data.category_id = data.category_id || null;
        await fetch(API + "/categories", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(data),
        });
        closeCategoryForm();
        fetchCategories();
        fetchCategoriesForSelect();
      });

      async function fetchCategories() {
        const res = await fetch(API + "/categories");
        const data = await res.json();
        const c = document.getElementById("categories-list");
        c.innerHTML = "";
        if (!data.length) {
          c.innerHTML = '<div class="muted">No categories</div>';
          return;
        }
        const table = el("table");
        table.innerHTML =
          "<thead><tr><th>ID</th><th>Name</th><th>Description</th><th></th></tr></thead>";
        const tbody = el("tbody");
        data.forEach((cat) => {
          const tr = el("tr");
          tr.innerHTML = `<td>${cat.category_id || ""}</td><td>${
            cat.category_name
          }</td><td>${cat.description || ""}</td>`;
          const actions = el("td");
          const del = el(
            "button",
            { onclick: () => deleteCategory(cat.category_id) },
            "Delete"
          );
          actions.appendChild(del);
          tr.appendChild(actions);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        c.appendChild(table);
      }
      async function deleteCategory(id) {
        if (!confirm("Delete category " + id + "?")) return;
        await fetch(API + "/categories/" + id, { method: "DELETE" });
        fetchCategories();
        fetchCategoriesForSelect();
      }

      /* ----------------- ADMIN: CUSTOMERS ----------------- */
      function openCustomerForm() {
        document.getElementById("customer-form").classList.remove("hidden");
      }
      function closeCustomerForm() {
        document.getElementById("custf").reset();
        document.getElementById("customer-form").classList.add("hidden");
      }

      document.getElementById("custf").addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        await fetch(API + "/customers", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(data),
        });
        closeCustomerForm();
        fetchCustomers();
      });

      async function fetchCustomers() {
        const res = await fetch(API + "/customers");
        const data = await res.json();
        const c = document.getElementById("customers-list");
        c.innerHTML = "";
        if (!data.length) {
          c.innerHTML = '<div class="muted">No customers</div>';
          return;
        }
        const table = el("table");
        table.innerHTML =
          "<thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th></tr></thead>";
        const tbody = el("tbody");
        data.forEach((u) => {
          const tr = el("tr");
          tr.innerHTML = `<td>${u.customer_id || ""}</td><td>${
            u.first_name || ""
          } ${u.last_name || ""}</td><td>${u.email || ""}</td><td>${
            u.phone || ""
          }</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        c.appendChild(table);
      }

      /* ----------------- ADMIN: ORDERS ----------------- */
      function openOrderForm() {
        document.getElementById("order-form").classList.remove("hidden");
      }
      function closeOrderForm() {
        document.getElementById("of").reset();
        document.getElementById("order-items-area").innerHTML = "";
        document.getElementById("order-form").classList.add("hidden");
      }

      function addOrderItemRow() {
        const area = document.getElementById("order-items-area");
        const row = document.createElement("div");
        row.className = "row";
        row.style.marginTop = "6px";
        const prodSelect = document.createElement("select");
        prodSelect.name = "product_id";
        prodSelect.style.flex = "2";
        const qty = document.createElement("input");
        qty.name = "quantity";
        qty.type = "number";
        qty.value = 1;
        qty.style.flex = "1";
        const price = document.createElement("input");
        price.name = "price";
        price.type = "number";
        price.step = "0.01";
        price.style.flex = "1";
        const remove = document.createElement("button");
        remove.type = "button";
        remove.textContent = "Remove";
        remove.addEventListener("click", () => row.remove());
        row.appendChild(prodSelect);
        row.appendChild(qty);
        row.appendChild(price);
        row.appendChild(remove);
        area.appendChild(row);
        fetchProductsForOrder(prodSelect);
      }

      async function fetchProductsForOrder(selectEl) {
        const res = await fetch(API + "/products");
        const data = await res.json();
        if (selectEl) {
          selectEl.innerHTML = "";
          data.forEach((p) => {
            const o = document.createElement("option");
            o.value = p.product_id;
            o.textContent = `${p.product_name} (${p.price})`;
            selectEl.appendChild(o);
          });
          return;
        }
        document.querySelectorAll("#order-items-area select").forEach((sel) => {
          sel.innerHTML = "";
          data.forEach((p) => {
            const o = document.createElement("option");
            o.value = p.product_id;
            o.textContent = `${p.product_name} (${p.price})`;
            sel.appendChild(o);
          });
        });
      }

      document.getElementById("of").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const obj = Object.fromEntries(fd.entries());
        const order_id = obj.order_id || Math.floor(Date.now() / 1000);
        const customer_id = obj.customer_id;
        const status = obj.status || "Pending";
        const items = [];
        document.querySelectorAll("#order-items-area .row").forEach((r) => {
          const select = r.querySelector("select");
          const qty = r.querySelector('input[name="quantity"]');
          const price = r.querySelector('input[name="price"]');
          if (select && qty) {
            items.push({
              product_id: parseInt(select.value),
              quantity: parseInt(qty.value || 1),
              price: parseFloat(price.value || 0),
            });
          }
        });
        if (items.length === 0) return alert("Add at least one item");
        const payload = {
          order_id: parseInt(order_id),
          customer_id: parseInt(customer_id),
          status,
          items,
        };
        const res = await fetch(API + "/orders", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        });
        const resp = await res.json();
        alert("Order created. Total: " + resp.total);
        closeOrderForm();
        fetchOrders();
      });

      async function fetchOrders() {
        const res = await fetch(API + "/orders");
        const data = await res.json();
        const c = document.getElementById("orders-list");
        c.innerHTML = "";
        if (!data.length) {
          c.innerHTML = '<div class="muted">No orders</div>';
          return;
        }
        data.forEach((o) => {
          const box = el("div", { class: "card" });
          box.innerHTML = `<div class="row" style="justify-content:space-between"><strong>Order ${
            o.order_id
          }</strong><div class="muted">${o.order_date || ""} • ${
            o.status
          }</div></div>
      <div class="small">Customer: ${
        o.customer_name || o.customer_id || ""
      } • Total: ${o.total || 0}</div>`;
          const it = el("table");
          it.innerHTML =
            "<thead><tr><th>Product</th><th>Qty</th><th>Price</th></tr></thead>";
          const tb = el("tbody");
          (o.items || []).forEach((i) => {
            const tr = el("tr");
            tr.innerHTML = `<td>${i.product_name || i.product_id}</td><td>${
              i.quantity
            }</td><td>${i.price}</td>`;
            tb.appendChild(tr);
          });
          it.appendChild(tb);
          box.appendChild(it);
          c.appendChild(box);
        });
      }

      /* ----------------- ADMIN: PAYMENTS ----------------- */
      function openPaymentForm() {
        document.getElementById("payment-form").classList.remove("hidden");
      }
      function closePaymentForm() {
        document.getElementById("payf").reset();
        document.getElementById("payment-form").classList.add("hidden");
      }

      document.getElementById("payf").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = {
          order_id: fd.get("order_id"),
          payment_method: fd.get("payment_method"),
          status: fd.get("status") || "Success",
        };
        await fetch(API + "/payments", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(data),
        });
        closePaymentForm();
        fetchPayments();
      });

      async function fetchPayments() {
        const res = await fetch(API + "/payments");
        const data = await res.json();
        const c = document.getElementById("payments-list");
        c.innerHTML = "";
        if (!data.length) {
          c.innerHTML = '<div class="muted">No payments</div>';
          return;
        }
        const table = el("table");
        table.innerHTML =
          "<thead><tr><th>ID</th><th>Order</th><th>Amount</th><th>Method</th><th>Status</th></tr></thead>";
        const tb = el("tbody");
        data.forEach((p) => {
          const tr = el("tr");
          tr.innerHTML = `<td>${p.payment_id || ""}</td><td>${
            p.order_id || ""
          }</td><td>${p.amount || ""}</td><td>${
            p.payment_method || ""
          }</td><td>${p.status || ""}</td>`;
          tb.appendChild(tr);
        });
        table.appendChild(tb);
        c.appendChild(table);
      }

      /* ----------------- USER: product grid ----------------- */
      let storeProducts = [];
      let cart = [];

      async function fetchProductsForStore() {
        const res = await fetch(API + "/products");
        const data = await res.json();
        storeProducts = data.filter((p) => p.stock > 0);
        renderProductGrid();
      }

      function renderProductGrid() {
        const grid = document.getElementById("product-grid");
        grid.innerHTML = "";
        if (!storeProducts.length) {
          grid.innerHTML = '<div class="muted">No products available</div>';
          return;
        }
        storeProducts.forEach((p) => {
          const card = el("div", { class: "product-card" });
          card.innerHTML = `<div style="font-weight:700">${p.product_name}</div>
            <div class="muted small">${p.category_name || ""}</div>
            <div style="margin:8px 0">${p.description || ""}</div>
            <div class="price">₹ ${p.price || 0}</div>
            <div class="muted small">Stock: ${p.stock || 0}</div>`;
          const add = el(
            "button",
            { class: "btn", onclick: () => addToCart(p.product_id) },
            "Add to cart"
          );
          card.appendChild(add);
          grid.appendChild(card);
        });
      }

      function addToCart(pid) {
        const prod = storeProducts.find((x) => x.product_id == pid);
        if (!prod) return alert("Product not found");
        const existing = cart.find((c) => c.product_id == pid);
        if (existing) {
          if (existing.quantity + 1 > prod.stock)
            return alert("Not enough stock");
          existing.quantity += 1;
        } else
          cart.push({
            product_id: pid,
            product_name: prod.product_name,
            price: prod.price,
            quantity: 1,
          });
        updateCartUI();
      }

      function updateCartUI() {
        document.getElementById("cart-count").textContent = cart.reduce(
          (s, i) => s + i.quantity,
          0
        );
        const items = document.getElementById("cart-items");
        if (!items) return;
        items.innerHTML = "";
        if (!cart.length)
          items.innerHTML = '<div class="muted">Cart is empty</div>';
        cart.forEach((it, idx) => {
          const row = el("div", { class: "row" });
          row.innerHTML = `<div style="flex:2">${
            it.product_name
          }</div><div style="flex:1">Qty: ${
            it.quantity
          }</div><div style="flex:1">₹ ${it.price * it.quantity}</div>`;
          const rem = el(
            "button",
            {
              onclick: () => {
                cart.splice(idx, 1);
                updateCartUI();
              },
            },
            "Remove"
          );
          row.appendChild(rem);
          items.appendChild(row);
        });
        document.getElementById("cart-total").textContent = cart
          .reduce((s, i) => s + i.price * i.quantity, 0)
          .toFixed(2);
      }

      function openCart() {
        document.getElementById("cart-modal").classList.remove("hidden");
        updateCartUI();
      }
      function closeCart() {
        document.getElementById("cart-modal").classList.add("hidden");
      }

      function checkout() {
        if (!cart.length) return alert("Cart empty");
        closeCart();
        document.getElementById("checkout-form").classList.remove("hidden");
      }

      function cancelCheckout() {
        document.getElementById("checkoutf").reset();
        document.getElementById("checkout-form").classList.add("hidden");
      }

      document
        .getElementById("checkoutf")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = Object.fromEntries(new FormData(e.target).entries());
          let customer_id =
            data.customer_id && data.customer_id.trim()
              ? parseInt(data.customer_id)
              : null;
          if (!customer_id) {
            const custPayload = {
              first_name: data.first_name,
              last_name: data.last_name,
              email: data.email,
              phone: data.phone,
            };
            await fetch(API + "/customers", {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify(custPayload),
            });
          }
          const order_id = Math.floor(Date.now() / 1000);
          const items = cart.map((c) => ({
            product_id: c.product_id,
            quantity: c.quantity,
            price: c.price,
          }));
          const payload = {
            order_id,
            customer_id: customer_id || null,
            status: "Pending",
            items,
          };
          const res = await fetch(API + "/orders", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload),
          });
          const resp = await res.json();
          alert("Order created (id: " + order_id + "). Total: ₹" + resp.total);
          document.getElementById("pay-order-id").textContent = order_id;
          document.getElementById("pay-amount").textContent = resp.total;
          document.getElementById("checkout-form").classList.add("hidden");
          document.getElementById("payment-ui").classList.remove("hidden");
        });

      /* -------- USER PAYMENT (NO AMOUNT, NO PAYMENT ID) -------- */
      document
        .getElementById("payf-user")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const order_id = parseInt(
            document.getElementById("pay-order-id").textContent
          );

          const payment_method = e.target.payment_method.value;

          const payload = {
            order_id,
            payment_method,
            status: "Success",
          };

          await fetch(API + "/payments", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload),
          });

          alert("Payment recorded. Thank you!");
          cart = [];
          updateCartUI();
          document.getElementById("payment-ui").classList.add("hidden");

          fetchProductsForStore();
          fetchProducts();
          fetchOrders();
          fetchPayments();
        });

      function cancelPayment() {
        document.getElementById("payment-ui").classList.add("hidden");
      }

      enterRole("landing");

      async function fetchAllAdmin() {
        fetchProducts();
        fetchCategories();
        fetchCustomers();
        fetchOrders();
        fetchPayments();
      }

      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          if (
            !document
              .getElementById("admin-content")
              .classList.contains("hidden")
          ) {
            fetchAllAdmin();
          } else if (
            !document.getElementById("user-ui").classList.contains("hidden")
          ) {
            fetchProductsForStore();
          }
        }
      });
    </script>
  </body>
</html>
